(function(){var t=this,i=function(t){if(!t||!t.canvas||!t.path)throw"ImgZoom constructor: missing arguments canvas or path";this.num=!0,this.canvas=t.canvas,this.contrler=t.contrler,this.context=this.canvas.getContext("2d"),this.mask=t.mask,this.imgRoate=t.imgRoate,this.beforeRoate=t.beforeRoate,this.desktop=t.desktop||!1,this.position={x:0,y:0},this.scale={x:.1,y:.1},this.imgTexture=new Image,this.imgTexture.src=t.path,this.lastZoomScale=null,this.lastX=null,this.lastY=null,this.mdown=!1,this.init=!1,this.checkRequestAnimationFrame(),requestAnimationFrame(this.animate.bind(this)),this.setEventListeners()};i.prototype={animate:function(){if(!this.init&&this.imgTexture.width){var t=null;t=this.imgTexture.height>=this.imgTexture.width?this.canvas.width/this.imgTexture.width:this.canvas.height/this.imgTexture.height,this.scale.x=t,this.scale.y=t,this.init=!0}if(this.context.clearRect(0,0,1e3,1e3),this.context.drawImage(this.imgTexture,this.position.x,this.position.y,this.scale.x*this.imgTexture.width,this.scale.y*this.imgTexture.height),this.num){switch(this.beforeRoate){case 3:this.context.rotate(-180*Math.PI/180),this.context.translate(-this.canvas.width,-this.canvas.height);break;case 6:this.context.rotate(-90*Math.PI/180),this.context.translate(-this.canvas.width,0);break;case 8:this.context.rotate(-270*Math.PI/180),this.context.translate(0,-this.canvas.height)}switch(this.imgRoate){case 3:this.context.translate(this.canvas.width,this.canvas.height),this.context.rotate(180*Math.PI/180);break;case 6:this.context.translate(this.canvas.width,0),this.context.rotate(90*Math.PI/180);break;case 8:this.context.translate(0,this.canvas.height),this.context.rotate(270*Math.PI/180)}this.num=!1}requestAnimationFrame(this.animate.bind(this))},gesturePinchZoom:function(t){var i=!1;if(t.targetTouches.length>=2){var e=t.targetTouches[0],s=t.targetTouches[1],n=Math.sqrt(Math.pow(s.pageX-e.pageX,2)+Math.pow(s.pageY-e.pageY,2));this.lastZoomScale&&(i=n-this.lastZoomScale),this.lastZoomScale=n}return i},doZoom:function(t){if(t){var i=this.scale.x,e=this.scale.x+t/100,s=e-i,n=this.imgTexture.width*this.scale.x,h=this.imgTexture.height*this.scale.y,a=this.imgTexture.width*s,o=this.imgTexture.height*s,c=this.canvas.width/2,r=this.canvas.height/2,l=-this.position.x+c,m=-this.position.y+r,u=-l/n,d=-m/h,g=this.position.x+a*u,w=this.position.y+o*d,x=n+a,v=h+o;x<this.canvas.width||(g>0&&(g=0),g+x<this.canvas.width&&(g=this.canvas.width-x),v<this.canvas.height||(w>0&&(w=0),w+v<this.canvas.height&&(w=this.canvas.height-v),this.scale.x=e,this.scale.y=e,this.position.x=g,this.position.y=w))}},doMove:function(t,i){if(this.lastX&&this.lastY){var e=t-this.lastX,s=i-this.lastY;switch(this.imgTexture.width,this.scale.x,this.imgTexture.height,this.scale.y,this.imgRoate){case 3:this.position.x-=e,this.position.y-=s;break;case 6:this.position.x+=s,this.position.y-=e;break;case 8:this.position.x-=s,this.position.y+=e;break;default:this.position.x+=e,this.position.y+=s}}this.lastX=t,this.lastY=i},setEventListeners:function(){this.contrler.addEventListener("touchstart",function(t){this.lastX=null,this.lastY=null,this.lastZoomScale=null}.bind(this)),this.contrler.addEventListener("touchmove",function(t){if(t.preventDefault(),2==t.targetTouches.length)this.doZoom(this.gesturePinchZoom(t));else if(1==t.targetTouches.length){var i=t.targetTouches[0].pageX-this.contrler.getBoundingClientRect().left,e=t.targetTouches[0].pageY-this.contrler.getBoundingClientRect().top;this.doMove(i,e)}}.bind(this)),this.desktop&&(window.addEventListener("keyup",function(t){187==t.keyCode||61==t.keyCode?this.doZoom(5):54==t.keyCode&&this.doZoom(-5)}.bind(this)),window.addEventListener("mousedown",function(t){this.mdown=!0,this.lastX=null,this.lastY=null}.bind(this)),window.addEventListener("mouseup",function(t){this.mdown=!1}.bind(this)),window.addEventListener("mousemove",function(t){var i=t.pageX-this.contrler.getBoundingClientRect().left,e=t.pageY-this.contrler.getBoundingClientRect().top;t.target==this.contrler&&this.mdown&&this.doMove(i,e),(i<=0||i>=this.contrler.clientWidth||e<=0||e>=this.contrler.clientHeight)&&(this.mdown=!1)}.bind(this)))},checkRequestAnimationFrame:function(){for(var t=0,i=["ms","moz","webkit","o"],e=0;e<i.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i,e){var s=(new Date).getTime(),n=Math.max(0,16-(s-t)),h=window.setTimeout(function(){i(s+n)},n);return t=s+n,h}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}},t.ImgTouchCanvas=i}).call(this);/*  |xGv00|a24584d6aa38038d17832c817cc0b452 */